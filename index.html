<!DOCTYPE html>
<html lang="pl">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz generator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>


    <script>
        tailwind.config = {
        theme: {
            extend: {
                colors: {
                white: "#fff",
                orange: "#f60",
                gray: {
                    50: "#fafafa",
                    100: "#f5f5f5",
                    200: "#eeeeee",
                    300: "#e0e0e0",
                    400: "#bdbdbd",
                    500: "#9e9e9e",
                    600: "#757575",
                    700: "#616161",
                    800: "#424242",
                    900: "#212121",
                },
            },
            }
        }
        }
    </script>

    <style>

        body {
            font-family: 'Inter', sans-serif;
        }

        .loadingbar {
            height: 4px;
            margin-bottom: -4px;
            overflow: hidden;
            position: relative;
        }
        
        .loadingbar div:before {
            content: "";
            position: absolute;
            top: 0px;
            left: 0px;
            bottom: 0px;
            background: #fff;
            animation: box-1 2100ms cubic-bezier(0.65, 0.81, 0.73, 0.4) infinite;
        }
        
        .loadingbar div:after {
            content: "";
            position: absolute;
            top: 0px;
            left: 0px;
            bottom: 0px;
            background: #fff;
            animation: box-2 2100ms cubic-bezier(0.16, 0.84, 0.44, 1) infinite;
            animation-delay: 1150ms;
        }
        
        @keyframes box-1 {
            0% {
                left: -35%;
                right: 100%;
            }
        
            60%, 100% {
                left: 100%;
                right: -90%;
            }
        }
        
        @keyframes box-2 {
            0% {
                left: -200%;
                right: 100%;
            }
        
            60%, 100% {
                left: 107%;
                right: -8%;
            }
        }
        
        .loadingSpinner {
            animation: rotate 2s linear infinite;
        }
        
        .loadingSpinner .spinnerPath {
          stroke-linecap: round;
          animation: dash 1.5s ease-in-out infinite;
        }
        
        @keyframes rotate {
          100% {
            transform: rotate(360deg);
          }
        }
        
        @keyframes dash {
          0% {
            stroke-dasharray: 1, 150;
            stroke-dashoffset: 0;
          }
          50% {
            stroke-dasharray: 90, 150;
            stroke-dashoffset: -35;
          }
          100% {
            stroke-dasharray: 90, 150;
            stroke-dashoffset: -124;
          }
        }

        .fadeIn {
            animation: fadeIn 0.15s ease-in-out;
        }

        .fadeOut {
            animation: fadeOut 0.15s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        #progress {
            -webkit-transition: width 0.2s ease-in-out;
            -moz-transition: width 0.2s ease-in-out;
            -o-transition: width 0.2s ease-in-out;
            transition: width 0.2s ease-in-out;
  
        }

        .progress-ring__circle {
            transition: 0.5s stroke-dashoffset, 0.5s stroke;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .progress-ring__text {
            transition: 0.5s fill;
            font-size: 24px;
            fill: white;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .progress-ring__background {
            stroke: #374151;
        }
        
    </style>

</head>
<body class="bg-[#1f1e1e]">

    <main>

    <div id="move-to-mobile" class="hidden sm:flex flex-col h-svh text-center justify-center items-center p-4">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="#e3a008" class="size-12"><path d="M16 64C16 28.7 44.7 0 80 0L304 0c35.3 0 64 28.7 64 64l0 384c0 35.3-28.7 64-64 64L80 512c-35.3 0-64-28.7-64-64L16 64zM144 448c0 8.8 7.2 16 16 16l64 0c8.8 0 16-7.2 16-16s-7.2-16-16-16l-64 0c-8.8 0-16 7.2-16 16zM304 64L80 64l0 320 224 0 0-320z"/></svg>

        <h2 class="text-center font-semibold mt-3 text-2xl text-gray-200">Switch to your phone</h2>
        <p class="max-w-96 mt-2 text-gray-400">Currently AI quiz generator is not optimized very well to be ran on large screens. Make your browser's window smaller or open this app on your phone to continue.</p>
        
    </div>

    <div id="screen-main" class="sm:hidden flex flex-col h-svh min-h-fit">

        <div id="createNewTestDiv" class="p-3">
            <div id="createStep1" class="mb-4">
                <label class="block text-xs font-normal text-gray-500 dark:text-gray-400 mb-1 select-none">1. Paste Gemini or    API key</label>

                <input type="password" name="apikey" id="apikey" class="peer border border-[#3c3c3a] bg-[#1f1e1e] py-1.5 rounded-md w-full focus:outline-none focus:ring-2 ring-[#344c96] px-3 text-gray-200 placeholder:text-[#4d4b4b] data-[error=true]:border-red-500 data-[error=true]:text-red-200" placeholder="The API provider will be detected automatically" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-error="false" required>
            
                <span id="error-message" class="text-xs font-normal text-gray-500 dark:text-gray-400 mt-1 select-none peer-data-[error=true]:text-red-500 flex"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="12" class="mr-1 hidden" fill="#ef4444"><path d="M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c-13.3 0-24 10.7-24 24l0 112c0 13.3 10.7 24 24 24s24-10.7 24-24l0-112c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>
                    <span id="incorrectText">This app is ran on your device. This key won't be sent anywhere else than to the API endpoint. This key is not stored on your device and will be cleared as soon as you close or refresh this page.</span></span>

                <script>
                    $(document).ready(function() {
                        $('#apikey').on('blur', function() {
                            const errorMessage = $('#error-message');
                            const apiKey = $(this).val();
                            const geminiPattern = /^AIza[0-9A-Za-z-_]{35}$/;
                            const openAIPattern = /^sk-.*/;

                            if(geminiPattern.test(apiKey)) window.apiProvider = 'gemini';
                            if(openAIPattern.test(apiKey)) window.apiProvider = 'openai';

                            if (geminiPattern.test(apiKey) || openAIPattern.test(apiKey)) {
                                $(this).attr('data-error', 'false');
                                $('#error-message span').text("This app is ran on your device. This key won't be sent anywhere else than to the API endpoint. This key is not stored on your device and will be cleared as soon as you close or refresh this page.");
                                $('#error-message svg').addClass('hidden');
                            } else {
                                $(this).attr('data-error', 'true');
                                $('#error-message span').text('The API key seems to be in a wrong format...');
                                $('#error-message svg').removeClass('hidden');
                            }
                        });
                    });

                    $('#apikey').on('focus', function() {
                        $(this).attr('data-error', 'false');
                                $('#error-message span').text("This app is ran on your device. This key won't be sent anywhere else than to the API endpoint. This key is not stored on your device and will be cleared as soon as you close or refresh this page.");
                                $('#error-message svg').addClass('hidden');
                    });
                </script>

            </div>

            <div id="createStep2" class="mb-4">
                <label class="block text-xs font-normal text-gray-500 dark:text-gray-400 mb-1 select-none">2. Type what you want the quiz to be about</label> 

                <input type="text" name="topic" id="topic" class="peer border border-[#3c3c3a] bg-[#1f1e1e] py-1.5 rounded-md w-full focus:outline-none focus:ring-2 ring-[#344c96] px-3 text-gray-200 placeholder:text-[#4d4b4b]" placeholder="eg. Linux commands" required>

            </div>
            <div id="createStep3" class="">
                <label class="block text-xs font-normal text-gray-500 dark:text-gray-400 mb-1 select-none">3. Enter the content on which the quiz should be prepared (optional)</label>

                <textarea name="resources" id="resources" class="border border-[#3c3c3a] bg-[#1f1e1e] py-1.5 rounded-md w-full focus:outline-none focus:ring-2 ring-[#344c96] px-3 text-gray-200 placeholder:text-[#4d4b4b] max-h-64" placeholder="Paste the content of the websites, PDF files and other resources you want the quiz to be based on" required></textarea>

                <!-- Tutaj dać divider "You can also import PDFs"
                <div class="flex items-center justify-center my-2">
                    <div class="flex-grow border-t border-gray-700"></div>
                    <span class="mx-4 text-gray-300" style="font-variant: all-small-caps">You can also import PDFs</span>
                    <div class="flex-grow border-t border-gray-700"></div>
                </div>

                <div class="container mx-auto mt-4">
                    <div id="drop-area" class="border border-dashed p-4 text-center cursor-pointer bg-[#1f1e1e] text-gray-300 hover:border-gray-700 border-[#3c3c3a] transition duration-150 rounded-md shadow-md flex flex-col items-center max-w-[48rem]">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="text-gray-400 mb-3" width="25" fill="#9ca3af"><path d="M69.9 153.4L198.5 10.6C204.5 3.9 213.2 0 222.3 0l3.5 0c9.1 0 17.7 3.9 23.8 10.6L378.1 153.4c3.8 4.2 5.9 9.8 5.9 15.5c0 12.8-10.4 23.1-23.1 23.1L288 192l0 128c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32l0-128-72.9 0C74.4 192 64 181.6 64 168.9c0-5.7 2.1-11.2 5.9-15.5zM64 352l0 64c0 17.7 14.3 32 32 32l256 0c17.7 0 32-14.3 32-32l0-64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 64c0 53-43 96-96 96L96 512c-53 0-96-43-96-96l0-64c0-17.7 14.3-32 32-32s32 14.3 32 32z"/></svg>
                        <h3 class="text-lg font-medium text-center mb-1 text-gray-200">Click to select files</h3>
                    </div>
                    <div id="file-list" class="mt-4">
                    </div>
                </div>
                <input type="file" id="file-input" multiple style="display:none;"/>
                <script>
                        let allowedExtensions = ['pdf'];

function isValidExtension(fileName) {
    let ext = fileName.split('.').pop().toLowerCase();
    return allowedExtensions.includes(ext);
}

$('#drop-area').on('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    $(this).addClass('bg-[#2d2d2d] border-gray-500');
});

$('#drop-area').on('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    $(this).removeClass('bg-[#2d2d2d] border-gray-500');
});

$('#drop-area').on('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    $(this).removeClass('bg-[#2d2d2d] border-gray-500');
    let dt = e.originalEvent.dataTransfer;
    let filesToUpload = dt.files;
    handleFiles(Array.from(filesToUpload));
});

$('#drop-area').on('click', function() {
    $('#file-input').trigger('click');
});

$('#file-input').on('change', function() {
    handleFiles(this.files);
});

function handleFiles(droppedFiles) {
    for (let i = 0; i < droppedFiles.length; i++) {
        let file = droppedFiles[i];
        if (isValidExtension(file.name)) {
            addFileItem(file);
        } else {
            alert('Invalid file type: ' + file.name);
        }
    }
}

function addFileItem(file) {
    let fileItem = $('<div class="file-item flex items-center justify-between p-2 bg-gray-900 rounded-md border border-gray-700 mb-2"></div>');
    let iconClass = getIconClass(file.name);
    let fileIcon = $(`<div class="file-icon ${iconClass} w-8 h-8 flex items-center justify-center mr-2 rounded-md select-none">
                       <span class="text-xs font-medium">${iconClass.split(' ')[0].toUpperCase()}</span>
                     </div>`);

    let fileName = $('<div class="truncate max-w-xs" style="color: #fefefe;">' + file.name + '</div>');
    let fileSize = $('<div class="text-gray-500 text-xs">' + (file.size / 1024).toFixed(2) + ' KB</div>');
    let removeBtn = $('<button class="remove-btn text-[##6b7280] hover:bg-gray-800 text-xs p-1 px-1.5 aspect-square rounded-md transition duration-150"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="16" fill="#9ca3af"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg></button>');

    fileItem.append(fileIcon, fileName, fileSize, removeBtn);
    $('#file-list').append(fileItem);

    removeBtn.on('click', function() {
        $(this).closest('.file-item').remove();
    });
}

function getIconClass(fileName) {
    let ext = fileName.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'img bg-gray-600';
    if (['pdf'].includes(ext)) return 'pdf bg-red-600 text-white';
    if (['doc', 'docx'].includes(ext)) return 'doc bg-blue-600 text-white';
    if (['xls', 'xlsx'].includes(ext)) return 'xls bg-green-600 text-white';
    return 'default bg-gray-500';
}
                </script> -->

                <p class="text-center text-gray-700 text-sm mt-3">The quiz will contain around 20 single-choice questions</p>

            </div>
        </div>
        
        <div style="flex: 1; flex-grow: 3;"></div>

        <div id="startGeneratingTest" class="mt-auto flex-col p-3 flex">
            <button id="startGeneratingTestBtn" class="rounded-md p-2 bg-gray-100 hover:bg-gray-200 disabled:bg-gray-700 disabled:text-gray-400 transition duration-150 select-none" onclick="generateTest()" disabled>Generate quiz</button>
            <p class="text-center text-gray-700 text-xs mt-2 select-none">LLMs can make mistakes</p>

        </div>
    </div>

    <div id="screen-failed" class="hidden flex-col h-svh text-center justify-center items-center p-4">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="#dc2626" class="size-12"><path d="M140.6 21.2C154.1 7.7 172.4 .1 191.5 .1l129 0c19.1 0 37.4 7.6 50.9 21.1L490.8 140.6c13.5 13.5 21.1 31.8 21.1 50.9l0 129c0 19.1-7.6 37.4-21.1 50.9L371.4 490.8c-13.5 13.5-31.8 21.1-50.9 21.1l-129 0c-19.1 0-37.4-7.6-50.9-21.1L21.2 371.4C7.7 357.9 .1 339.6 .1 320.5l0-129c0-19.1 7.6-37.4 21.1-50.9L140.6 21.2zM175 175c-9.4 9.4-9.4 24.6 0 33.9l47 47-47 47c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l47-47 47 47c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-47-47 47-47c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-47 47-47-47c-9.4-9.4-24.6-9.4-33.9 0z"/></svg>

        <h2 class="text-center font-semibold mt-3 text-2xl text-gray-200">Failed to load the quiz</h2>
        <p id="failed-moreinfo" class="max-w-96 mt-2 text-gray-400">An error has occured while trying to generate your quiz. Please try again.</p>
        
    </div>
    <div id="screen-loading" class="hidden flex-col h-svh">

        <!-- <div class="h-1 p-0 m-0 bg-gray-700 overflow-hidden loadingbar"><div></div></div> -->

        <div class="text-center mt-[15%]">
            <h2 class="text-gray-50 font-medium text-lg">Your quiz is being prepared!</h2>
            <p class="text-gray-400">It can take a minute</p>
        </div>
        
        <div id="progressAnimation" class="text-center mt-[10%]">
            <style>
                .text-slider {
                    height: 40px;
                    overflow: hidden;
                    position: relative;
                }
                .text-slider ul {
                    position: absolute;
                    width: 100%;
                    transition: transform 0.2s ease-in-out;
                }
                .text-slider li {
                    list-style: none;
                    padding: 10px;
                    text-align: center;
                }
            </style>
            <div class="text-slider bg-[#1f1e1e] text-gray-300">
                <ul id="text-list">
                    <li>AI is generating your quiz...</li>
                    <li>This can take a while...</li>
                    <li>Reading your resources...</li>
                    <li>Browsing through your data...</li>
                    <li>Writing questions...</li>
                    <li>Reading your resources...</li>
                    <li>Coming up with questions...</li>
                    <li>Generating the quiz...</li>
                    <li>Preparing explanations for wrong answers...</li>
                    <li>Almost done!</li>
                </ul>
            </div>
            
            <script>
                $(document).ready(function() {
                    const $textList = $('#text-list');
                    const itemHeight = $textList.find('li').outerHeight();
                    const interval = 6000;
        
                    function scrollText() {
                        $textList.animate({
                            'marginTop': `-${itemHeight}px`
                        }, 400, function() {
                            $textList.find('li:first').appendTo($textList);
                            $textList.css('marginTop', 0);
                        });
                    }
        
                    setInterval(scrollText, interval);
                });
            </script>
        </div>

        <div style="flex: 1; flex-grow: 3;"></div>

        <div class="flex items-center content-center justify-center w-full mb-32">
            <!-- Spinner -->
            <svg class="loadingSpinner z-20 text-center size-12" viewBox="0 0 50 50">
                <circle class="spinnerPath stroke-gray-400 dark:stroke-gray-300" cx="25" cy="25" r="20" fill="none" stroke-width="2"></circle>
            </svg>
        </div>

        <div id="startGeneratingTest" class="flex mt-auto flex-col p-3 mb-3">
            <p class="text-center text-gray-400 text-sm mt-2 select-none">Keep this tab open</p>
        </div>
    </div>

    <div id="screen-finish" class="hidden flex-col h-svh">
        <h2 class="mt-4 text-2xl font-semibold text-center text-gray-50">Quiz finished!</h2>
        <svg class="progress-ring self-center mt-4" width="120px" height="120px" viewBox="0 0 120 120">
            <circle class="progress-ring__background" stroke-width="10" fill="transparent" r="52" cx="60" cy="60"/>
            <circle id="progress-ring-circle" class="progress-ring__circle" stroke="white" stroke-width="10" fill="transparent" r="52" cx="60" cy="60" stroke-linecap="round"/>
            <text x="60" y="60" class="progress-ring__text" id="progress-text">0%</text>
        </svg>

        <div id="answersOverview" class="flex flex-col mx-3 text-gray-200">
            <div id="qListDiv" class="flex flex-col w-full p-4 pt-0">
                
                <script>
                    function toggleMoreInfo(buttonId) {
                        const moreInfoDiv = $('#aoMoreInfo' + buttonId);
                        const svgIcon = $('#toggleAo' + buttonId + ' svg');
                        if (moreInfoDiv.hasClass('hidden')) {
                            moreInfoDiv.removeClass('hidden');
                            moreInfoDiv.addClass('max-h-96');
                            svgIcon.css('transform', 'rotate(180deg)');
                        } else {
                            moreInfoDiv.addClass('hidden');
                            moreInfoDiv.removeClass('max-h-96');
                            svgIcon.css('transform', 'rotate(0deg)');
                        }
                    }
                </script>
                
            </div>
        </div>

    </div>

    <div id="screen-test" class="hidden flex-col h-svh">

        <div class="h-1 p-0 m-0 bg-gray-700 overflow-hidden"><div id="progress" class="bg-gray-50 h-full transition duration-200"></div></div>


        <div class="flex-1 p-3" style="flex-grow: 3;">
            <div class="flex flex-row ml-1">
                <h3 id="questionNumber" class="text-white font-bold select-none text-lg">1.</h3>
                <h3 id="questionTitle" class="ml-2 text-white font-bold select-none text-lg">What is lorem ipsum?</h3>
            </div>

            <div id="answersDiv" class="m-1.5 mt-5 flex flex-col">
                <button class="answerBtn flex min-w-32 min-h-10 border-2 border-gray-700 rounded-lg text-white text-base select-none p-0 mb-3 hover:bg-gray-850 bg-gray-900 transition duration-150 h-fit w-fit max-w-72">
                    <div class="flex items-center justify-center w-10 aspect-square rounded-l-lg text-white text-xl font-bold">A</div>
                    <div class="flex-1 text-start content-center rounded-r-lg text-white border-l-2 px-2.5 border-gray-700 text-wrap h-10">
                        <p>Placeholder text</p>
                    </div>
                </button>
                <button class="answerBtn flex min-w-32 min-h-10 border-2 border-gray-700 rounded-lg text-white text-base select-none p-0 mb-3 hover:bg-gray-850 bg-gray-900 transition duration-150 h-fit w-fit max-w-72">
                    <div class="flex items-center justify-center w-10 aspect-square rounded-l-lg text-white text-xl font-bold">B</div>
                    <div class="flex-1 text-start content-center rounded-r-lg text-white border-l-2 px-2.5 border-gray-700 text-wrap h-10">
                        <p>Name of a printing company</p>
                    </div>
                </button>
                <button class="answerBtn flex min-w-32 min-h-10 border-2 border-gray-700 rounded-lg text-white text-base select-none p-0 mb-3 hover:bg-gray-850 bg-gray-900 transition duration-150 h-fit w-fit max-w-72">
                    <div class="flex items-center justify-center w-10 aspect-square rounded-l-lg text-white text-xl font-bold">C</div>
                    <div class="flex-1 text-start content-center rounded-r-lg text-white border-l-2 px-2.5 border-gray-700 text-wrap h-10">
                        <p>Font used in printing</p>
                    </div>
                </button>
            </div>

            <div id="answerRes" class="flex flex-col w-fit h-fit m-1.5 p-4 items-start content-start gap-2 flex-wrap rounded-lg" style="background: #450000;">
                <div class="flex text-xs font-bold uppercase leading-normal" style="color: #d30000; letter-spacing: 3px;">
                    <span id="answerResIcon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x leading-normal"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </span>

                    <p id="answerResTitle" class="ml-1.5" style="margin-top: 3.5px">INCORRECT ANSWER</p>
                </div>
                <p class="text-white text-sm font-normal text-wrap max-w-fit">Lorem ipsum is a placeholder text commonly used to demonstrate the visual form of a document or a typeface without relying on meaningful content.</p>
            </div>

        </div>

        <div class="flex p-3 mb-3 content-end">
            <button id="checkCorrectAnswer" class="aspect-square border-2 border-gray-700 rounded-lg text-gray-300 text-base select-none p-3 transition duration-150 bg-gray-900 hover:bg-gray-850" onclick="showCorrectAnswer()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye">
                    <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </button>

            <button id="testActionBtn" class="border-2 flex border-gray-700 rounded-lg text-gray-300 text-base select-none p-3 ml-3 transition duration-150 bg-gray-900 hover:bg-gray-850" onclick="testActionBtn()">
                <p class="mr-2">Next question</p>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </button>
        </div>
    </div>
    
    </main>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <script>
        // JSONREPAIR
        // THIS IS NOT MY CODE
        // I IMPORTED THIS CODE TO THIS FILE SO YOU CAN USE THIS APP ON YOUR PHONE

        ((t,e)=>{"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).JSONRepair={})})(this,function(t){class $ extends Error{constructor(t,e){super(t+" at position "+e),this.position=e}}let u=125,e=32,x=10,y=9,O=13,N=8,J=12,S=34,r=39,j=48,k=57,d=44,I=65,T=97,m=70,z=102,l=160,E=8192,R=8202,U=8239,Z=8287,_=12288,n=8220,o=8221,i=8216,c=8217,f=96,a=180;function F(t){return t>=j&&t<=k}function q(t){return h.test(t)}let h=/^[,:[\]/{}()\n+]$/,s=/^[,[\]/{}\n+]$/,W=/^[a-zA-Z_$]$/,X=/^[a-zA-Z_$0-9]$/;function B(t){return s.test(t)}function D(t){return A.test(t)||t&&H(t.charCodeAt(0))}let A=/^[[{\w-]$/;function G(t){return t===e||t===x||t===y||t===O}function H(t){return K(t)||M(t)}function K(t){return t===S||t===n||t===o}function L(t){return t===S}function M(t){return t===r||t===i||t===c||t===f||t===a}function P(t){return t===r}function Q(t,e,r){r=2<arguments.length&&void 0!==r&&r,e=t.lastIndexOf(e);return-1!==e?t.substring(0,e)+(r?"":t.substring(e+1)):t}function V(t,e){let r=t.length;if(!G(t.charCodeAt(r-1)))return t+e;for(;G(t.charCodeAt(r-1));)r--;return t.substring(0,r)+e+t.substring(r)}let Y={"\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t"},tt={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};t.JSONRepairError=$,t.jsonrepair=function(s){let A=0,C="";if(!i())throw new $("Unexpected end of json string",s.length);var t=c(d);if(t&&g(),D(s[A])&&/[,\n][ \t\r]*$/.test(C)){t||(C=V(C,","));{let t=!0,e=!0;for(;e;)t?t=!1:c(d)||(C=V(C,",")),e=i();C=`[
${C=e?C:Q(C,",")}
]`}}else t&&(C=Q(C,","));for(;s.charCodeAt(A)===u||93===s.charCodeAt(A);)A++,g();if(A>=s.length)return C;throw new $("Unexpected character "+JSON.stringify(s[A]),A);function i(){g();var t=(()=>{if(123!==s.charCodeAt(A))return!1;{C+="{",A++,g(),b(d)&&g();let e=!0;for(;A<s.length&&s.charCodeAt(A)!==u;){let t;if(e?(t=!0,e=!1):((t=c(d))||(C=V(C,",")),g()),f(),!(v()||a(!0))){s.charCodeAt(A)===u||123===s.charCodeAt(A)||93===s.charCodeAt(A)||91===s.charCodeAt(A)||void 0===s[A]?C=Q(C,","):(()=>{throw new $("Object key expected",A)})();break}g();var r=c(58),n=A>=s.length,o=(r||(D(s[A])||n?C=V(C,":"):h()),i());o||(r||n?C+="null":h())}return s.charCodeAt(A)===u?(C+="}",A++):C=V(C,"}"),!0}})()||(()=>{if(91!==s.charCodeAt(A))return!1;{C+="[",A++,g(),b(d)&&g();let t=!0;for(;A<s.length&&93!==s.charCodeAt(A);){t?t=!1:c(d)||(C=V(C,",")),f();var e=i();if(!e){C=Q(C,",");break}}return 93===s.charCodeAt(A)?(C+="]",A++):C=V(C,"]"),!0}})()||v()||(()=>{var t,e,r=A;if(45===s.charCodeAt(A)){if(A++,n())return o(r),!0;if(!F(s.charCodeAt(A)))return A=r,!1}for(;F(s.charCodeAt(A));)A++;if(46===s.charCodeAt(A)){if(A++,n())return o(r),!0;if(!F(s.charCodeAt(A)))return A=r,!1;for(;F(s.charCodeAt(A));)A++}if(101===s.charCodeAt(A)||69===s.charCodeAt(A)){if(A++,45!==s.charCodeAt(A)&&43!==s.charCodeAt(A)||A++,n())return o(r),!0;if(!F(s.charCodeAt(A)))return A=r,!1;for(;F(s.charCodeAt(A));)A++}if(n()){if(A>r)return t=s.slice(r,A),e=/^0\d/.test(t),C+=e?`"${t}"`:t,!0}else A=r;return!1})()||r("true","true")||r("false","false")||r("null","null")||r("True","true")||r("False","false")||r("None","null")||a(!1)||(()=>{if("/"===s[A]){var t=A;for(A++;A<s.length&&("/"!==s[A]||"\\"===s[A-1]);)A++;return A++,C+=`"${s.substring(t,A)}"`,!0}})();return g(),t}function g(){A;let t=e();for(;t=(t=(()=>{if(47===s.charCodeAt(A)&&42===s.charCodeAt(A+1)){for(;A<s.length&&!((t,e)=>"*"===t[e]&&"/"===t[e+1])(s,A);)A++;A+=2}else{if(47!==s.charCodeAt(A)||47!==s.charCodeAt(A+1))return!1;for(;A<s.length&&s.charCodeAt(A)!==x;)A++}return!0})())&&e(););A}function e(){let t="";for(var e,r;(e=G(s.charCodeAt(A)))||(r=s.charCodeAt(A))===l||r>=E&&r<=R||r===U||r===Z||r===_;)t+=e?s[A]:" ",A++;return 0<t.length&&(C+=t,!0)}function c(t){return s.charCodeAt(A)===t&&(C+=s[A],A++,!0)}function b(t){return s.charCodeAt(A)===t&&(A++,!0)}function f(){g(),46===s.charCodeAt(A)&&46===s.charCodeAt(A+1)&&46===s.charCodeAt(A+2)&&(A+=3,g(),b(d))}function v(t){var r,n,o=0<arguments.length&&void 0!==t&&t;let i=92===s.charCodeAt(A);if(i&&(A++,i=!0),H(s.charCodeAt(A))){var c=L(s.charCodeAt(A))?L:P(s.charCodeAt(A))?P:M(s.charCodeAt(A))?M:K,f=A,a=C.length;let e='"';for(A++;;){if(A>=s.length)return h=w(A-1),!o&&q(s.charAt(h))?(A=f,C=C.substring(0,a),v(!0)):(e=V(e,'"'),C+=e,!0);if(c(s.charCodeAt(A))){var h=A,u=e.length;if(e+='"',A++,C+=e,g(),o||A>=s.length||q(s.charAt(A))||H(s.charCodeAt(A))||F(s.charCodeAt(A)))return p(),!0;if(q(s.charAt(w(h-1))))return A=f,C=C.substring(0,a),v(!0);C=C.substring(0,a),A=h+1,e=e.substring(0,u)+"\\"+e.substring(u)}else{if(o&&B(s[A]))return e=V(e,'"'),C+=e,p(),!0;if(92===s.charCodeAt(A)){u=s.charAt(A+1);if(void 0!==tt[u])e+=s.slice(A,A+2),A+=2;else if("u"===u){let t=2;for(;t<6&&((n=s.charCodeAt(A+t))>=j&&n<=k||n>=I&&n<=m||n>=T&&n<=z);)t++;if(6===t)e+=s.slice(A,A+6),A+=6;else{if(!(A+t>=s.length))throw d=void 0,d=s.slice(A,A+6),new $(`Invalid unicode character "${d}"`,A);A=s.length}}else e+=u,A+=2}else{var d=s.charAt(A),l=s.charCodeAt(A);if(l===S&&92!==s.charCodeAt(A-1))e+="\\"+d;else if((r=l)===x||r===O||r===y||r===N||r===J)e+=Y[d];else{if(!(32<=(r=l)&&r<=1114111))throw l=void 0,l=d,new $("Invalid character "+JSON.stringify(l),A);e+=d}A++}}i&&b(92)}}return!1}function p(){let t=!1;for(g();43===s.charCodeAt(A);){t=!0,A++,g();var e=(C=Q(C,'"',!0)).length,r=v();C=r?(r=C,e=e,n=1,r.substring(0,e)+r.substring(e+n)):V(C,'"')}var n;t}function r(t,e){return s.slice(A,A+t.length)===t&&(C+=e,A+=t.length,!0)}function a(t){var e=A;if(W.test(s[A])){for(;A<s.length&&X.test(s[A]);)A++;let t=A;for(;G(s.charCodeAt(t));)t++;if("("===s[t])return A=t+1,i(),41===s.charCodeAt(A)&&(A++,59===s.charCodeAt(A))&&A++,!0}for(;A<s.length&&!B(s[A])&&!H(s.charCodeAt(A))&&(!t||":"!==s[A]);)A++;if(A>e){for(;G(s.charCodeAt(A-1))&&0<A;)A--;e=s.slice(e,A);return C+="undefined"===e?"null":JSON.stringify(e),s.charCodeAt(A)===S&&A++,!0}}function w(t){let e=t;for(;0<e&&G(s.charCodeAt(e));)e--;return e}function n(){return A>=s.length||q(s[A])||G(s.charCodeAt(A))}function o(t){C+=s.slice(t,A)+"0"}function h(){throw new $("Colon expected",A)}}});

    </script>
    <script>
        const { jsonrepair } = JSONRepair
    </script>
    <!-- <script>
        PDFJS.workerSrc = 'pdf.worker.mjs';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.mjs"></script> -->
    <script>
        
        function isTestDataValid(testData) {
    if(!testData) return 'No test data provided';
    if(!testData.pytania) return 'No questions provided';
    if(testData.pytania.length === 0) return 'No questions provided';
    if(!testData.nazwa_przedmiotu) return 'No subject name provided';
    if(!testData.numer_dzialu) return 'No section number provided';
    if(!testData.nazwa_dzialu) return 'No section name provided';

    for(let i = 0; i < testData.pytania.length; i++) {

        if(!testData.pytania[i].tresc_pytania) return 'No question text provided for question ' + i;
        if(!testData.pytania[i].typ_pytania) return 'No question type provided for question ' + i;
        if(!testData.pytania[i].odpowiedzi) return 'No answers provided for question ' + i;
        if(testData.pytania[i].odpowiedzi.length === 0) return 'No answers provided for question ' + i;
        if(!testData.pytania[i].wyjasnienie_poprawna) return 'No correct answer explanation provided for question ' + i;
        if(!testData.pytania[i].wyjasnienie_bledna) return 'No wrong answer explanation provided for question ' + i;

        for(let j = 0; j < testData.pytania[i].odpowiedzi.length; j++) {
            if(!testData.pytania[i].odpowiedzi[j].tresc_odpowiedzi) return 'No answer text provided for answer ' + j + ' in question ' + i;
            if(!testData.pytania[i].odpowiedzi[j].poprawna) return 'No answer correctness provided for answer ' + j + ' in question ' + i;
        }

        let poprawne = 0;
        for(let j = 0; j < testData.pytania[i].odpowiedzi.length; j++) {
            if(testData.pytania[i].odpowiedzi[j].poprawna === true) poprawne++;
        }
        if(poprawne !== 1) return 'Invalid number of correct answers for question ' + i;
    }

    return true;
}

let testData = null;
// let files = [];
// let fileInput = $('#file-input');

function startTest() {
    testData = JSON.parse(testData);
    console.log(testData);
    if(!testData) {
        console.error("No quiz data");
        return false;
    } else if(!isTestDataValid(testData)) {
        console.error("Quiz data is invalid");
        return false;
    }

    window.nrPytania = 0;
    window.sumaPytan = testData.pytania.length;

    $('#screen-main').addClass('hidden');

    $('#screen-test').addClass('flex');
    $('#screen-test').removeClass('hidden');

    // Uruchom interfejs testu
    // Pokaż progressbar
	window.promptToNotClose = true;

    generujPytanie();
}


function generujPytanie() {
    let nrPytania = window.nrPytania;
    $('#answerRes').addClass('hidden');

    $('#questionNumber').html(nrPytania + 1 + '.');
    $('#questionTitle').html(testData.pytania[nrPytania].tresc_pytania);

    $('#progress').css('width', ((nrPytania + 1) / window.sumaPytan) * 100 + '%');

    $('#checkCorrectAnswer').addClass('hidden');
    
    if(testData.pytania[nrPytania].typ_pytania === 'jednokrotnego_wyboru') {
        
        $('#testActionBtn').addClass('hidden');
        $('#testActionBtn').html('<p class="mr-2">Next question</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>');

        let alphabet = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M'];
        let odpowiedzHTML = '';

        for(let i = 0; i < testData.pytania[nrPytania].odpowiedzi.length; i++) {

            odpowiedzHTML += '<button id="odp' + i + '" class="answerBtn flex min-w-32 min-h-10 border-2 border-gray-700 rounded-lg text-white text-base select-none p-0 mb-3 hover:bg-gray-850 bg-gray-900 transition duration-150 h-fit w-fit max-w-72" style="width: 220.05px;" onclick="answerClicked(' + i + ')"><div id="odpL' + i + '" class="flex items-center justify-center w-10 aspect-square rounded-l-lg text-white text-xl font-bold">' + alphabet[i] + '</div><div id="odpT' + i + '" class="flex-1 text-start content-center rounded-r-lg text-white border-l-2 px-2.5 border-gray-700 text-wrap h-10"><p>' + testData.pytania[nrPytania].odpowiedzi[i].tresc_odpowiedzi + '</p></div></button>';
        }

        $('#answersDiv').html(odpowiedzHTML);
        
        // $('.answerBtn').css('width', '');
        $('.answerBtn').width('');

        var max = 0;
        $(".answerBtn").each(function() {
            var w = $(this).width();
            if (w > max) {
                max = w;
            }
        });
        $(".answerBtn").width(max);

        window.currentQType = 'jednokrotnego_wyboru';

    }
}

function answerClicked(idOdpowiedzi) {
    if(window.answerShown === true) return;

    let nrPytania = window.nrPytania;
    let typPytania = window.currentQType;

    if(typPytania === 'jednokrotnego_wyboru') {
        let poprawna = testData.pytania[nrPytania].odpowiedzi[idOdpowiedzi].poprawna;

        if(poprawna === true) {
            $('#answerRes').css('background', '#004518');
            $('#answerRes div').css('color', '#00d348');
            $('#answerRes p').text(testData.pytania[nrPytania].wyjasnienie_poprawna);
            $('#answerRes #answerResTitle').text('CORRECT ANSWER');
            $('#answerRes div #answerResIcon').html('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check leading-normal"><path d="M20 6 9 17l-5-5"/></svg>');

            $('#odp' + idOdpowiedzi).css('background', '#004518');
            $('#odp' + idOdpowiedzi).css('border', '2px solid #00d348');
            $('#odp' + idOdpowiedzi + ' #odpL' + idOdpowiedzi).css('color', '#00d348');
            $('#odp' + idOdpowiedzi + ' #odpL' + idOdpowiedzi).html('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check leading-normal"><path d="M20 6 9 17l-5-5"/></svg>');
            $('#odp' + idOdpowiedzi + ' #odpT' + idOdpowiedzi).css('border-left', '2px solid #00d348');
            $('#odp' + idOdpowiedzi).addClass('correctAnswerShown');

            let answerInfo = {
                "answer_clicked": idOdpowiedzi,
                "was_correct": true
            };
            testData.pytania[nrPytania].odpowiedz_usera = answerInfo;

        } else {
            $('#answerRes').css('background', '#450000');
            $('#answerRes div').css('color', '#d30000');
            $('#answerRes p').text(testData.pytania[nrPytania].wyjasnienie_bledna);
            $('#answerRes #answerResTitle').text('INCORRECT ANSWER');
            $('#answerRes div #answerResIcon').html('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x leading-normal"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>');

            // Zmień styl przycisku
            $('#odp' + idOdpowiedzi).addClass('previousLetter' + $('#odp' + idOdpowiedzi + ' #odpL' + idOdpowiedzi).html());
            $('#odp' + idOdpowiedzi).css('background', '#450000');
            $('#odp' + idOdpowiedzi).css('border', '2px solid #d30000');
            $('#odp' + idOdpowiedzi + ' #odpL' + idOdpowiedzi).css('color', '#d30000');
            $('#odp' + idOdpowiedzi + ' #odpL' + idOdpowiedzi).html('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x leading-normal"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>');
            $('#odp' + idOdpowiedzi + ' #odpT' + idOdpowiedzi).css('border-left', '2px solid #d30000');
            $('#odp' + idOdpowiedzi).addClass('wrongAnswerShown');

            // Add correntAnswerShouldBe class to correct answer
            for(let i = 0; i < testData.pytania[nrPytania].odpowiedzi.length; i++) {
                if(testData.pytania[nrPytania].odpowiedzi[i].poprawna === true) {
                    $('#odp' + i).addClass('correctAnswerShouldBe');
                    $('#odp' + i).addClass('previousLetter' + $('#odp' + i + ' #odpL' + i).html());
                }
            }

            $('#checkCorrectAnswer').removeClass('hidden');

            let answerInfo = {
                "answer_clicked": idOdpowiedzi,
                "was_correct": false
            };
            testData.pytania[nrPytania].odpowiedz_usera = answerInfo;

        }
        
        $('#answerRes').removeClass('hidden');
        $('#testActionBtn').removeClass('hidden');
        $('.answerBtn').addClass('cursor-default');
        $('.answerBtn').removeClass('hover:bg-gray-850');
        window.answerShown = true;

        if(nrPytania + 1 === window.sumaPytan) {
            $('#testActionBtn').html('<p class="mr-2">Finish quiz</p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>');
        }
    }
};

function testActionBtn() {
    if(window.nrPytania + 1 === window.sumaPytan) {

        // Zakończ test
        updateQuestionsList();
        promptToNotClose = false;
        
        $('#screen-test').addClass('hidden');
        $('#screen-test').removeClass('flex');
        $('#screen-finish').removeClass('hidden');
        $('#screen-finish').addClass('flex');

        let poprawne = 0;
        for(let i = 0; i < testData.pytania.length; i++) {
            if(testData.pytania[i].odpowiedz_usera.was_correct === true) poprawne++;
        }

        let wynik = Math.round((poprawne / testData.pytania.length) * 100);

        setTimeout(() => {
            setRingScore(wynik);
        }, 100);

    } else {
        // Następne pytanie
        $('#checkCorrectAnswer').removeClass('border-gray-500');
        $('#checkCorrectAnswer').removeClass('text-gray-200');
        $('#checkCorrectAnswer').removeClass('bg-gray-800');
        $('#checkCorrectAnswer').removeClass('hover:bg-gray-850');
        $('#checkCorrectAnswer').addClass('border-gray-700');
        $('#checkCorrectAnswer').addClass('text-gray-300');
        $('#checkCorrectAnswer').addClass('bg-gray-900');
        $('#checkCorrectAnswer').addClass('hover:bg-gray-850');
        window.correntAnswerShouldBeShown = false;
        window.answerShown = false;
        window.nrPytania++;
        generujPytanie();
    }
}

function showCorrectAnswer() {
    if(window.answerShown === true && !window.correntAnswerShouldBeShown) {
        $('#answerRes').addClass('hidden');

        $('#checkCorrectAnswer').removeClass('border-gray-700');
        $('#checkCorrectAnswer').removeClass('text-gray-300');
        $('#checkCorrectAnswer').removeClass('bg-gray-900');
        $('#checkCorrectAnswer').removeClass('hover:bg-gray-850');

        $('#checkCorrectAnswer').addClass('border-gray-500');
        $('#checkCorrectAnswer').addClass('text-gray-200');
        $('#checkCorrectAnswer').addClass('bg-gray-800');
        $('#checkCorrectAnswer').addClass('hover:bg-gray-850');

        window.correntAnswerShouldBeShown = true;

        // Get .wrongAnswerShown answer id
        let idOdpowiedziW = $('.wrongAnswerShown').attr('id').replace('odp', '');

        $('.wrongAnswerShown').css('background', '');
        $('.wrongAnswerShown').css('border', '');
        $('.wrongAnswerShown #odpL' + idOdpowiedziW).css('color', '');

        // Przywróć literkę
        $('.wrongAnswerShown #odpL' + idOdpowiedziW).html($('.wrongAnswerShown').attr('class').split(' ').find(e => e.includes('previousLetter')).replace('previousLetter', ''));

        $('.wrongAnswerShown #odpT' + idOdpowiedziW).css('border-left', '');

        // ---

        // Get .correctAnswerShouldBe answer id
        let idOdpowiedziC = $('.correctAnswerShouldBe').attr('id').replace('odp', '');

        // Zmień styl przycisku
        $('.correctAnswerShouldBe').css('background', '#004518');
        $('.correctAnswerShouldBe').css('border', '2px dashed #00d348');
        $('.correctAnswerShouldBe' + ' #odpL' + idOdpowiedziC).css('color', '#00d348');
        $('.correctAnswerShouldBe' + ' #odpL' + idOdpowiedziC).html('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check leading-normal"><path d="M20 6 9 17l-5-5"/></svg>');
        $('.correctAnswerShouldBe' + ' #odpT' + idOdpowiedziC).css('border-left', '2px dashed #00d348');



    } else if(window.answerShown === true && window.correntAnswerShouldBeShown) {
        $('#answerRes').removeClass('hidden');

        $('#checkCorrectAnswer').removeClass('border-gray-500');
        $('#checkCorrectAnswer').removeClass('text-gray-200');
        $('#checkCorrectAnswer').removeClass('bg-gray-800');
        $('#checkCorrectAnswer').removeClass('hover:bg-gray-850');
        $('#checkCorrectAnswer').addClass('border-gray-700');
        $('#checkCorrectAnswer').addClass('text-gray-300');
        $('#checkCorrectAnswer').addClass('bg-gray-900');
        $('#checkCorrectAnswer').addClass('hover:bg-gray-850');

        window.correntAnswerShouldBeShown = false;

        // Get .wrongAnswerShown answer id
        let idOdpowiedziW = $('.wrongAnswerShown').attr('id').replace('odp', '');

        $('.wrongAnswerShown').css('background', '#450000');
        $('.wrongAnswerShown').css('border', '2px solid #d30000');
        $('.wrongAnswerShown' + ' #odpL' + idOdpowiedziW).css('color', '#d30000');
        $('.wrongAnswerShown' + ' #odpL' + idOdpowiedziW).html('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x leading-normal"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>');
        $('.wrongAnswerShown' + ' #odpT' + idOdpowiedziW).css('border-left', '2px solid #d30000');

        // ---

        // Get .correctAnswerShouldBe answer id
        let idOdpowiedziC = $('.correctAnswerShouldBe').attr('id').replace('odp', '');

        // Zmień styl przycisku
        $('.correctAnswerShouldBe').css('background', '');
        $('.correctAnswerShouldBe').css('border', '');
        $('.correctAnswerShouldBe' + ' #odpL' + idOdpowiedziC).css('color', '');
        $('.correctAnswerShouldBe' + ' #odpL' + idOdpowiedziC).html($('.correctAnswerShouldBe').attr('class').split(' ').find(e => e.includes('previousLetter')).replace('previousLetter', ''));
        $('.correctAnswerShouldBe' + ' #odpT' + idOdpowiedziC).css('border-left', '');
    }
}

var $circle = $('#progress-ring-circle');
var $text = $('#progress-text');
var radius = $circle[0].r.baseVal.value;
var circumference = radius * 2 * Math.PI;

$circle.css('strokeDasharray', `${circumference} ${circumference}`);
$circle.css('strokeDashoffset', `${circumference}`);

function setRingScore(percent) {
    const offset = circumference - percent / 100 * circumference;
    $circle.css('strokeDashoffset', offset);
    $text.text(`${percent}%`);

    console.log(percent);

    if (percent < 25) {
        $circle.css('stroke', '#e02424');
        $text.css('fill', '#e02424');
    } else if (percent >= 25 && percent <= 35) {
        $circle.css('stroke', '#f59e0b');
        $text.css('fill', '#f59e0b');
    } else {
        $circle.css('stroke', '#0e9f6e');
        $text.css('fill', '#0e9f6e');
    }
}

function updateQuestionsList() {
    if(window.nrPytania + 1 === window.sumaPytan) {
		// Zakończ test
        for(let i = 0; i < testData.pytania.length; i++) {
            let pytanie = testData.pytania[i];
            let odp = pytanie.odpowiedz_usera;

            if(odp.was_correct === true) {
                $('#qListDiv').append(`<div class="qListElement w-full border-b border-gray-800 pb-4 mt-4">
                    <div class="flex flex-row w-full items-center">
                        <div class="mr-2 p-0.5 rounded" style="background: #004518"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00d348" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check leading-normal"><path d="M20 6 9 17l-5-5"/></svg></div>
                        <p>${i+1}. ${pytanie.tresc_pytania}</p>
                        
                        <div class="flex-1"></div>

                        <!-- Dropdown -->
                        <button id="toggleAo${i}" class="border-2 border-gray-700 rounded-lg text-gray-300 text-base select-none p-0.5 transition duration-150 bg-gray-900 hover:bg-gray-850" onclick="toggleMoreInfo(${i})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></button>
                    </div>

                    <div id="aoMoreInfo${i}" class="aoMoreInfo hidden mt-2">
                        In this question you've selected the correct answer - ${odp.answer_clicked+1}. ${pytanie.odpowiedzi[odp.answer_clicked].tresc_odpowiedzi}. <br>
                        ${pytanie.wyjasnienie_poprawna}
                    </div>
                </div>`);
            } else {
                $('#qListDiv').append(`<div class="qListElement w-full border-b border-gray-800 pb-4 mt-4">
                    <div class="flex flex-row w-full items-center">
                        <div class="mr-2 p-0.5 rounded" style="background: #450000"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d30000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x leading-normal"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></div>
                        <p>${pytanie.tresc_pytania}</p>
                        
                        <div class="flex-1"></div>

                        <!-- Dropdown -->
                        <button id="toggleAo${i}" class="border-2 border-gray-700 rounded-lg text-gray-300 text-base select-none p-0.5 transition duration-150 bg-gray-900 hover:bg-gray-850" onclick="toggleMoreInfo(${i})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></button>
                    </div>

                    <div id="aoMoreInfo${i}" class="aoMoreInfo hidden mt-2">
                        Unfortunately you didn't answer this question correctly.<br>
                        You have selected: ${odp.answer_clicked+1}. ${pytanie.odpowiedzi[odp.answer_clicked].tresc_odpowiedzi}.<br>
                        The correct answer is: ${pytanie.odpowiedzi.find(e => e.poprawna === true).tresc_odpowiedzi}.<br>
                        <br>
                        Explanation:<br>
                        ${pytanie.wyjasnienie_bledna}
                    </div>
                </div>`);
            }

        }

    }
}

async function generateTest() {
	window.promptToNotClose = true;
    $('#screen-main').addClass('hidden');
    $('#screen-loading').removeClass('hidden');
    $('#screen-loading').addClass('flex');


	let apikey = $('#apikey').val();
    let topic = $('#topic').val();
    let resources = $('#resources').val();

    // if(!verifyApiKey() || !topic) {
    //     $('#screen-loading').addClass('hidden').removeClass('flex');
    //     $('#screen-failed').addClass('flex').removeClass('hidden');
    //     $('#failed-moreinfo').html('Please fill all the fields');
    //     return;
    // }

    let systemPrompt = `You are an AI model that generates tests, quizzes, and assessments based on content provided by the user. You respond ONLY in the presented JSON syntax, exclusively generate tests for the user, and do not answer their questions in any other way, ever.

    Each test you generate must be heavily based on the content provided by the user. The user will provide you with texts from various articles, publications, etc. Your task is to read them and devise questions that the user will have to answer to test their understanding of these texts.

    The length of each test should be APPROXIMATELY 20 QUESTIONS. The limit is 23 questions. Try to keep the quiz/test under 21 questions!!!

    Explanation of the individual JSON fields:
    \`tresc_pytania\`: As the name suggests, this is the question you ask the user. You provide only the content of the question here, without any numbering or answers. Also, avoid asking questions that could in any way suggest the correct answer to the user.
    \`typ_pytania\`: This field must ALWAYS be: \`jednokrotnego_wyboru\`, without quotes or apostrophes. This field indicates to the application through which the user will answer the questions that only one answer is correct in a given question. ALL questions in the test must be multiple-choice (single-select).
    \`odpowiedzi\`: Contains a set of multiple-choice answers that the user can select. There must be at least TWO and a maximum of SEVEN proposed answers. No less than two, no more than seven. These can be answers referring to the text, true/false, or choose the correct sentence ending.

    Generate knowledge tests in JSON format based on the content provided by the user. Respond only in the established JSON syntax, creating multiple-choice questions based on the given content, without answering other user questions.

    Rules for creating a test:

    - The test should contain approximately 20 questions, no more than 21 and no less than 19.
    - Each question must be rooted in the provided content.
    - All questions must be of the "jednokrotnego_wyboru" type (single-select multiple-choice).
    - Each answer must have a clearly assigned correctness (one correct answer).
    - Answers should not contain more than four words.
    - Provide explanations for both correct and incorrect answers in a short form.
    - Do not ask only questions about dates or years. Make the questions more diverse.
    - Do not refer to the text ("As seen in the text") in either the question content or the answer explanations, as the user does not have the text in front of them, they cannot see it.

    # Output Format

    The following JSON format should be used for each question:
    \`\`\`json
    {
      "tresc_pytania": "Your question here",
      "typ_pytania": jednokrotnego_wyboru,
      "odpowiedzi": [
        {"tresc_odpowiedzi": "Answer A", "poprawna": false},
        {"tresc_odpowiedzi": "Answer B", "poprawna": true},
        {"tresc_odpowiedzi": "Answer C", "poprawna": false}
      ],
      "wyjasnienie_poprawna": "Short explanatory answer for the correct answer.",
      "wyjasnienie_bledna": "Short explanatory answer for the incorrect answer."
    }
    \`\`\`

    # Examples

    Example JSON of a single question:

    \`\`\`json
    {
      "tresc_pytania": "What is the main topic of the article?",
      "typ_pytania": jednokrotnego_wyboru,
      "odpowiedzi": [
        {"tresc_odpowiedzi": "Ecology", "poprawna": false},
        {"tresc_odpowiedzi": "Politics", "poprawna": true},
        {"tresc_odpowiedzi": "Culture", "poprawna": false}
      ],
      "wyjasnienie_poprawna": "The article focuses on current political events.",
      "wyjasnienie_bledna": "The main topic is politics, as indicated by the part of the article devoted to election campaigns."
    }
    \`\`\`

    # Notes

    - Ask questions diversely and uniquely until the resource of content material is exhausted.
    - If the token limit is reached, continue generating from the point of termination with new JSON formatting.
    - Take special care to ensure that the questions and answers are unambiguous and not misleading.
    \`tresc_odpowiedzi\`: Similar to the \`tresc_pytania\` field, but referring to one of the many answers to choose from. Again, without any question numbering. The answer should also not be too long. Try to stay within the limit of four words.
    \`poprawna\`: This field contains the value \`true\` or \`false\` indicating whether the given answer to the question is correct or not. In each question, there will always be only ONE answer with the value \`true\`. NO MORE, NO LESS. Always exactly ONE answer will be correct.
    \`wyjasnienie_poprawna\`: The content of this field will be displayed to the user if they manage to select the correct answer. The content of this field should be short, concise, and not exceed two sentences. You can explain here why the indicated answer is correct and you can also provide an interesting fact related to the question. You can also quote from the text to confirm that this answer is correct.
    \`wyjasnienie_bledna\`: The content of this field will be displayed to the user if they select an incorrect answer to the given question. Here, too, the field should be short and concise. Explain to the user where they made a mistake, what the correct answer should be, and you can also quote from the text that says which answer should be correct. The length of this field should not exceed three sentences.

    Sometimes, your response may reach the maximum allowed number of output tokens. In such a case, the user will ask you to continue generating the response. Then, you start your response by restarting the JSON code from scratch with the question you left off. The unfinished fragment will be automatically corrected later, and the last question will be deleted from the JSON code.`;


    // let files = fileInput[0].files;
    // console.log(files);
    // if(files.length > 0) {
    //     filesText = '';
    //     for(let i = 0; i < files.length; i++) {
    //         let file = files[i];
    //         let reader = new FileReader();
    //         reader.onload = function(e) {
    //             let text = e.target.result;
    //             filesText += text;
    //         }
    //         reader.readAsText(file);
    //     }
    // }
    // if (files.length > 0) {
    //     filesText = '';
    //     for (let i = 0; i < files.length; i++) {
    //         let file = files[i];
    //         if (file.type === 'application/pdf') {
    //             let reader = new FileReader();
    //             reader.onload = function (e) {
    //                 let typedarray = new Uint8Array(e.target.result);
    //                 PDFJS.getDocument(typedarray).promise.then(function (pdf) {
    //                     let totalPages = pdf.numPages;
    //                     let pageTextPromises = [];
    //                     for (let j = 1; j <= totalPages; j++) {
    //                         pageTextPromises.push(pdf.getPage(j).then(function (page) {
    //                             return page.getTextContent().then(function (textContent) {
    //                                 return textContent.items.map(item => item.str).join(' ');
    //                             });
    //                         }));
    //                     }
    //                     Promise.all(pageTextPromises).then(function (texts) {
    //                         filesText += texts.join(' ');
    //                     });
    //                 });
    //             };
    //             reader.readAsArrayBuffer(file);
    //         } else {
    //             let reader = new FileReader();
    //             reader.onload = function (e) {
    //                 filesText += e.target.result;
    //             };
    //             reader.readAsText(file);
    //         }
    //     }
    // }

    // console.log(filesText);

    if(window.apiProvider === 'gemini') {

        async function run() {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apikey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [
                        {
                            role: "user",
                            parts: [
                                {
                                    text: `Generate a quiz based on the following topic: ${topic}. Resources provided by the user: ${resources}. ${filesText ? 'Files provided by the user: ' + filesText : ''}`
                                }
                            ]
                        }
                    ],
                    systemInstruction: {
                        role: "user",
                        parts: [
                            {
                                text: systemPrompt
                            }
                        ]
                    },
                    generationConfig: {
                        temperature: 0.95,
                        topK: 64,
                        topP: 0.95,
                        maxOutputTokens: 8192,
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "object",
                            properties: {
                                pytania: {
                                    type: "array",
                                    items: {
                                        type: "object",
                                        properties: {
                                            tresc_pytania: {
                                                type: "string"
                                            },
                                            typ_pytania: {
                                                type: "string"
                                            },
                                            odpowiedzi: {
                                                type: "array",
                                                items: {
                                                    type: "object",
                                                    properties: {
                                                        tresc_odpowiedzi: {
                                                        type: "string"
                                                        },
                                                        poprawna: {
                                                        type: "boolean"
                                                        }
                                                    },
                                                    required: [
                                                        "tresc_odpowiedzi",
                                                        "poprawna"
                                                    ]
                                                }
                                            },
                                            wyjasnienie_poprawna: {
                                                type: "string"
                                            },
                                            wyjasnienie_bledna: {
                                                type: "string"
                                            }
                                        },
                                        required: [
                                            "tresc_pytania",
                                            "typ_pytania",
                                            "odpowiedzi",
                                            "wyjasnienie_poprawna",
                                            "wyjasnienie_bledna"
                                        ]
                                    }
                                }
                            },
                            required: [
                                "pytania"
                            ]
                        }
                    }
                })
            });

            const result = await response.json();
            return result;
        }

        let modelAnswer = await run();
        // let modelAnswerText = JSON.stringify(modelAnswer.candidates[0].content.parts[0].text);
        // Instead, make modelAnswerText JSON object additionaly fixed by jsonrepair function
        let modelAnswerText = JSON.parse(jsonrepair(JSON.stringify(modelAnswer.candidates[0].content.parts[0].text)));

        console.log(modelAnswer);

        if(modelAnswer.candidates.finishReason === 'MAX_TOKENS') {
            let maxTries = 5;
            let tries = 0;
            let generatrMode = true;

            let messageHistory = [
                {
                    role: "user",
                    parts: [
                        {
                            text: systemPrompt
                        }
                    ]
                },
                {
                    role: "model",
                    parts: [
                        {
                            text: modelAnswerText
                        }
                    ]
                }
            ];

            modelAnswerText = jsonrepair(modelAnswerText);
            modelAnswerText = JSON.parse(modelAnswerText);

            delete modelAnswerText.pytania[modelAnswerText.pytania.length - 1];

            while(generateMore && triess < maxTries) {
                console.log('Generating more');
                tries++;

                async function more() {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apikey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [
                                {
                                    role: "user",
                                    parts: [
                                        {
                                            text: "Continue"
                                        }
                                    ]
                                }
                            ],
                            systemInstruction: {
                                role: "user",
                                parts: [
                                    {
                                        text: systemPrompt
                                    }
                                ]
                            },
                            generationConfig: {
                                temperature: 0.95,
                                topK: 64,
                                topP: 0.95,
                                maxOutputTokens: 8192,
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "object",
                                    properties: {
                                        pytania: {
                                            type: "array",
                                            items: {
                                                type: "object",
                                                properties: {
                                                    tresc_pytania: {
                                                        type: "string"
                                                    },
                                                    typ_pytania: {
                                                        type: "string"
                                                    },
                                                    odpowiedzi: {
                                                        type: "array",
                                                        items: {
                                                            type: "object",
                                                            properties: {
                                                                tresc_odpowiedzi: {
                                                                    type: "string"
                                                                },
                                                                poprawna: {
                                                                    type: "boolean"
                                                                }
                                                            },
                                                            required: [
                                                                "tresc_odpowiedzi",
                                                                "poprawna"
                                                            ]
                                                        }
                                                    },
                                                    wyjasnienie_poprawna: {
                                                        type: "string"
                                                    },
                                                    wyjasnienie_bledna: {
                                                        type: "string"
                                                    }
                                                },
                                                required: [
                                                    "tresc_pytania",
                                                    "typ_pytania",
                                                    "odpowiedzi",
                                                    "wyjasnienie_poprawna",
                                                    "wyjasnienie_bledna"
                                                ]
                                            }
                                        }
                                    },
                                    required: [
                                        "pytania"
                                    ]
                                }
                            }
                        })
                    });

                    const result = await response.json();
                    return result;
                }

                let modelAnswerMore = await more();
                let modelAnswerTextMore = JSON.parse(jsonrepair(JSON.stringify(modelAnswerMore.candidates[0].content.parts[0].text)));
                

                if(modelAnswerMore.candidates.finishReason !== "MAX_TOKENS") {
                    generateMore = false;
                    modelAnswerTextMore = jsonrepair(modelAnswerTextMore);
                    modelAnswerTextMore = JSON.parse(modelAnswerTextMore);
                    modelAnswerText.pytania = modelAnswerText.pytania.concat(modelAnswerTextMore.pytania);
                } else {
                    modelAnswerTextMore = jsonrepair(modelAnswerTextMore);
                    modelAnswerTextMore = JSON.parse(modelAnswerTextMore);
                    delete modelAnswerTextMore.pytania[modelAnswerTextMore.pytania.length - 1];

                    modelAnswerText.pytania = modelAnswerText.pytania.concat(modelAnswerTextMore.pytania);
                }
            }

            if(tries === maxTries) {
                $('#screen-loading').addClass('hidden').removeClass('flex');
                $('#screen-failed').addClass('flex').removeClass('hidden');
                $('#failed-moreinfo').html('Failed to generate the quiz. Please refresh the page and try again (reached max tries limit for generating more questions).');
                return;
            }
        }

        $('#screen-loading').addClass('hidden').removeClass('flex');
        testData = modelAnswerText;
        startTest();
    } else if(window.apiProvider === 'openai') {
        console.log('openai');

        async function run() {
            const response = await fetch(`https://api.openai.com/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apikey}`
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                {
                    role: "system",
                    content: systemPrompt
                },
                {
                    role: "user",
                    content: `Generate a quiz based on the following topic: ${topic}. Resources provided by the user: ${resources}`
                }
                ],
                response_format: {
                type: "json_schema",
                json_schema: {
                    name: "test",
                    strict: false,
                    schema: {
                    properties: {
                        pytania: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                            tresc_pytania: {
                                type: "string"
                            },
                            typ_pytania: {
                                type: "string"
                            },
                            odpowiedzi: {
                                type: "array",
                                items: {
                                type: "object",
                                properties: {
                                    tresc_odpowiedzi: {
                                    type: "string"
                                    },
                                    poprawna: {
                                    type: "boolean"
                                    }
                                },
                                required: [
                                    "tresc_odpowiedzi",
                                    "poprawna"
                                ]
                                }
                            },
                            wyjasnienie_poprawna: {
                                type: "string"
                            },
                            wyjasnienie_bledna: {
                                type: "string"
                            }
                            },
                            required: [
                            "tresc_pytania",
                            "typ_pytania",
                            "odpowiedzi",
                            "wyjasnienie_poprawna",
                            "wyjasnienie_bledna"
                            ]
                        }
                        }
                    },
                    required: [
                        "pytania"
                    ],
                    type: "object"
                    }
                }
                },
                temperature: 1,
                max_completion_tokens: 16383,
                top_p: 1,
                frequency_penalty: 0,
                presence_penalty: 0
            })
            });

            const result = await response.json();
            return result;
        }

        let modelAnswer = await run();
        let modelAnswerText = JSON.parse(jsonrepair(modelAnswer.choices[0].message.content));

        console.log(modelAnswer);

        if(modelAnswer.choices[0].finish_reason === 'length') {
            let maxTries = 5;
            let tries = 0;
            let generateMore = true;

            modelAnswerText = JSON.parse(jsonrepair(modelAnswer.choices[0].message.content));

            delete modelAnswerText.pytania[modelAnswerText.pytania.length - 1];

            while(generateMore && tries < maxTries) {
            console.log('Generating more');
            tries++;

            async function more() {
                const response = await fetch(`https://api.openai.com/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apikey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                    {
                        role: "system",
                        content: systemPrompt
                    },
                    {
                        role: "user",
                        content: "Continue"
                    }
                    ],
                    response_format: {
                    type: "json_schema",
                    json_schema: {
                        name: "test",
                        strict: false,
                        schema: {
                        properties: {
                            pytania: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                tresc_pytania: {
                                    type: "string"
                                },
                                typ_pytania: {
                                    type: "string"
                                },
                                odpowiedzi: {
                                    type: "array",
                                    items: {
                                    type: "object",
                                    properties: {
                                        tresc_odpowiedzi: {
                                        type: "string"
                                        },
                                        poprawna: {
                                        type: "boolean"
                                        }
                                    },
                                    required: [
                                        "tresc_odpowiedzi",
                                        "poprawna"
                                    ]
                                    }
                                },
                                wyjasnienie_poprawna: {
                                    type: "string"
                                },
                                wyjasnienie_bledna: {
                                    type: "string"
                                }
                                },
                                required: [
                                "tresc_pytania",
                                "typ_pytania",
                                "odpowiedzi",
                                "wyjasnienie_poprawna",
                                "wyjasnienie_bledna"
                                ]
                            }
                            }
                        },
                        required: [
                            "pytania"
                        ],
                        type: "object"
                        }
                    }
                    },
                    temperature: 1,
                    max_completion_tokens: 16383,
                    top_p: 1,
                    frequency_penalty: 0,
                    presence_penalty: 0
                })
                });

                const result = await response.json();
                return result;
            }

            let modelAnswerMore = await more();
            let modelAnswerTextMore = JSON.parse(jsonrepair(modelAnswerMore.choices[0].message.content));

            if(modelAnswerMore.choices[0].finish_reason !== "length") {
                generateMore = false;
                modelAnswerTextMore = jsonrepair(modelAnswerTextMore);
                modelAnswerTextMore = JSON.parse(modelAnswerTextMore);
                modelAnswerText.pytania = modelAnswerText.pytania.concat(modelAnswerTextMore.pytania);
            } else {
                modelAnswerTextMore = jsonrepair(modelAnswerTextMore);
                modelAnswerTextMore = JSON.parse(modelAnswerTextMore);
                delete modelAnswerTextMore.pytania[modelAnswerTextMore.pytania.length - 1];

                modelAnswerText.pytania = modelAnswerText.pytania.concat(modelAnswerTextMore.pytania);
            }
            }

            if(tries === maxTries) {
            $('#screen-loading').addClass('hidden').removeClass('flex');
            $('#screen-failed').addClass('flex').removeClass('hidden');
            $('#failed-moreinfo').html('Failed to generate the quiz. Please refresh the page and try again (reached max tries limit for generating more questions).');
            return;
            }
        }

        $('#screen-loading').addClass('hidden').removeClass('flex');
        modelAnswerText = JSON.stringify(modelAnswerText);
        testData = modelAnswerText;
        startTest();
    } else {
        $('#screen-loading').addClass('hidden').removeClass('flex');
        $('#screen-failed').addClass('flex').removeClass('hidden');
        $('#failed-moreinfo').html('Could not recognize API provider.');
    }

}

window.onbeforeunload = function() {
	if(window.promptToNotClose) {
		return "Are you sure you want to leave this page?";
	}
};

// let apikey = $('#apikey').val();
// let topic = $('#topic').val();
// let resources = $('#resources').val();

$('#apiKey').on('input', function() {
    verifyInputs();
});

$('#topic').on('input', function() {
    verifyInputs();
});

function verifyApiKey() {
    const apiKey = $('#apikey').val();
    const geminiPattern = /^AIza[0-9A-Za-z-_]{35}$/;
    const openAIPattern = /^sk-[a-zA-Z0-9]/;

    if (geminiPattern.test(apiKey) || openAIPattern.test(apiKey)) {
        return true;
    } else {
        return false;
    }
}

function verifyInputs() {
    let apikey = $('#apikey').val();
    let topic = $('#topic').val();
    let resources = $('#resources').val();

    if(verifyApiKey() && topic.length > 0) {
        $('#startGeneratingTestBtn').prop('disabled', false);
    } else {
        $('#startGeneratingTestBtn').prop('disabled', true);
    }
}

    </script>

<noscript>Włącz obsługę JavaScript</noscript>

</body>
</html>